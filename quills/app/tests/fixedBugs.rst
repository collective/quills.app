Quills browser tests
====================

Here we check for fixed bugs usins tests, that don't fit into the 'narrative' in
the main browser test. First some boilerplate to get our browser up and running:

    >>> self.setRoles(("Contributor",))
    >>> browser = self.getBrowser(logged_in=True)
    >>> browser.handleErrors = False
    >>> entry = self.weblog.addEntry("Blog entry",
    ...                              "Just for testing",
    ...                              "Nothing to see.",
    ...                              ['fishslapping'],
    ...                              id="entry")
    >>> from quills.core.interfaces import IWeblogEntry
    >>> IWeblogEntry.providedBy(entry)
    True

Make it discussable and publish it

    >>> entry = self.weblog.getEntry('entry')
    >>> entry_content = entry.getWeblogEntryContentObject()
    >>> entry_content.allowDiscussion(allowDiscussion=True)
    >>> entry.publish()

    >>> date = entry.getPublicationDate()
    >>> year = str(date.year())
    >>> month = str(date.month()).zfill(2)
    >>> day = str(date.day()).zfill(2)

    >>> self.setRoles(("Contributor", "Reviewer", "Manager"))
    >>> browser.open('http://nohost/plone/weblog/%s/%s/%s/entry' % (year, month, day))
    >>> browser.getControl('Add Comment').click()
    >>> browser.getControl('Subject').value = "Parrot"
    >>> browser.getControl('Comment').value = "Is dead. Is deceased."

Issue #111 shows that the URLs generated by the archive portlet are not correct.
Even when the weblog is not supposed to be using an extra 'archive' URL segment,
the URLs always have that segment in them.

To test this, we'll first make sure that the weblog config is setup to use the
'archive' segment for URLs.

    >>> from quills.core.interfaces import IWeblogConfiguration
    >>> config = IWeblogConfiguration(self.weblog.getWeblogContentObject())
    >>> config.archive_format = 'archive'

Now we'll get a page and check its body for the appropriate link.

    >>> browser.open('http://nohost/plone/weblog/')
    >>> url = '<a href="http://nohost/plone/weblog/archive/%s/%s">'
    >>> url = url % (year, month)
    >>> url in browser.contents
    True

Now, if we change the archive_format, we should get different URLs.

    >>> config.archive_format = ''
    >>> browser.open('http://nohost/plone/weblog/')
    >>> url = '<a href="http://nohost/plone/weblog/%s/%s">'
    >>> url = url % (year, month)
    >>> url in browser.contents
    True


There was an issue whereby the correct comment count didn't get shown for each
weblog entry displayed in the weblog_view.  We verify that this is no longer
the case here.

First, let's add a comment so that we know one is there.

    >>> from Products.CMFCore.utils import getToolByName
    >>> dtool = getToolByName(self.portal, 'portal_discussion')
    >>> entry_discussion = dtool.getDiscussionFor(entry_content)
    >>> comment_id = entry_discussion.createReply(title='Comment Title',
    ...                                           text='a little test body')

Now, when we look at the weblog view, we should find that there is a link to the
comments for `entry', together with a count of how many comments there are on
it.

    >>> browser.open('http://nohost/plone/weblog/')
    >>> url = '<a href="http://nohost/plone/weblog/%s/%s/%s/entry#comments"'
    >>> url = url % (year, month, day)
    >>> url in browser.contents
    True
    >>> '<span>1</span>' in browser.contents
    True

>> repr(browser.contents)

This last line of test is fairly lame as it could potentially match anywhere in
the source.  An example of what we are really trying to match is the following:

"""
          <a href="http://nohost/plone/weblog/2007/09/24/entry#comments"
           style="text-decoration: none;">
          Comments:
          </a>

          <span>3</span>
"""


Issue #112 found that the recent comments portlet was generating incorrect links
to comments as it wasn't utilising the archive URL of the weblog entry objects.

    >>> txt = '<a href="http://nohost/plone/weblog/%s/%s/%s/entry#%s"'
    >>> txt = txt % (year, month, day, comment_id)
    >>> txt in browser.contents
    True


Issue #117 found that the weblog admin portlet got displayed to anonymous users,
rather than being restricted to admin-ish users.  Let's verify that this is no
longer the case.

    >>> self.setRoles([])
    >>> browser = self.getBrowser(logged_in=False)
    >>> browser.handleErrors = False
    >>> browser.open('http://nohost/plone/weblog/')
    >>> 'portletWeblogAdmin' in browser.contents
    False
